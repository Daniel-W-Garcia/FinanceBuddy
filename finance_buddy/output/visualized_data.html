<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Company Facts Snapshot - Charts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 24px; }
    .card { padding: 16px; border: 1px solid #ddd; border-radius: 8px; }
    h1 { margin-bottom: 8px; font-size: 20px; }
    h2 { margin: 0 0 12px 0; font-size: 16px; color: #444; }
  </style>
</head>
<body>
  <h1>Company Facts Snapshot</h1>
  <div id="meta"></div>
  <div class="grid">
    <div class="card"><h2>Revenue</h2><canvas id="rev"></canvas></div>
    <div class="card"><h2>Operating Income</h2><canvas id="opinc"></canvas></div>
    <div class="card"><h2>Net Income</h2><canvas id="netinc"></canvas></div>
    <div class="card"><h2>Diluted EPS</h2><canvas id="eps"></canvas></div>
  </div>

  <script>
    async function loadData() {
      const resp = await fetch('./company_facts_snapshot.json');
      if (!resp.ok) throw new Error('Failed to load JSON');
      return await resp.json();
    }

    function extractSeries(obj, key) {
      const arr = (obj[key] || []).filter(p => p && p.period && typeof p.value === 'number');
      // Sort by period label heuristically: LTM first, then descending FY
      const ltm = arr.filter(a => /LTM/i.test(a.period));
      const fys = arr
        .filter(a => /^FY\d{4}/.test(a.period))
        .sort((a, b) => parseInt(b.period.slice(2)) - parseInt(a.period.slice(2)));
      const ordered = [...ltm, ...fys];
      return {
        labels: ordered.map(p => p.period),
        values: ordered.map(p => p.value),
        unit: ordered[0]?.unit || ''
      };
    }

    function fmtCurrency(val, currency = 'USD') {
      try {
        return new Intl.NumberFormat(undefined, { style: 'currency', currency, maximumFractionDigits: 0 }).format(val);
      } catch {
        return `${currency} ${val.toLocaleString()}`;
      }
    }

    function fmtCompact(val) {
      // For large numbers (e.g., revenue), show compact human-readable values
      return new Intl.NumberFormat(undefined, { notation: 'compact', maximumFractionDigits: 1 }).format(val);
    }

    function makeBarChart(ctx, labels, values, title, formatter) {
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: title,
            data: values,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgb(54, 162, 235)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: (v) => formatter ? formatter(v) : v
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.raw;
                  return formatter ? `${ctx.dataset.label}: ${formatter(v)}` : `${ctx.dataset.label}: ${v}`;
                }
              }
            },
            legend: { display: false }
          }
        }
      });
    }

    (async () => {
      const data = await loadData();
      const currency = data.currency || 'USD';
      const ceo = data.ceo || '—';
      document.getElementById('meta').innerText = `Currency: ${currency}   •   CEO: ${ceo}`;

      const rev = extractSeries(data, 'revenue');
      const opi = extractSeries(data, 'operating_income');
      const net = extractSeries(data, 'net_income');
      const eps = extractSeries(data, 'diluted_eps');

      makeBarChart(document.getElementById('rev'), rev.labels, rev.values, 'Revenue', (v) => fmtCurrency(v, currency));
      makeBarChart(document.getElementById('opinc'), opi.labels, opi.values, 'Operating Income', (v) => fmtCurrency(v, currency));
      makeBarChart(document.getElementById('netinc'), net.labels, net.values, 'Net Income', (v) => fmtCurrency(v, currency));
      makeBarChart(document.getElementById('eps'), eps.labels, eps.values, 'Diluted EPS', (v) => v.toLocaleString(undefined, { maximumFractionDigits: 2 }));
    })().catch(err => {
      console.error(err);
      document.body.insertAdjacentHTML('beforeend', `<p style="color:red">Error: ${err.message}</p>`);
    });
  </script>
</body>
</html>